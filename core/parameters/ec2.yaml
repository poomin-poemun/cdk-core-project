---
PWorkInstance:
  securitygrps:
    pwork_instance_sg:
      id: "pwork_instance_sg"
      group_description: "PWork Instance OutPut SecurityGroup"
      group_name: "pwork_instance_sg"
      security_group_egress:
        - ip_protocol: "-1"
          cidr_ip: "0.0.0.0/0"
          description: "Allow all traffic."
      security_group_ingress:
        - ip_protocol: "tcp"
          cidr_ip: "0.0.0.0/0"
          from_port: 22
          to_port: 22
          description: "Allow SSH traffic."
      vpc_id: "{{pwork.vpcs.nyan_vpc.vpc_id}}"
      tags:
        - key: "module"
          value: "PworkInstance"

  roles:
    pwork_instance_role:
      id: "pwork_instance_role"
      role_name: "pwork_instance_role"
      description: "PWork Instance Role"
      assume_role_policy_document:
         "Version": "2012-10-17"
         "Statement":
           - "Effect": "Allow"
             "Action": "sts:AssumeRole"
             "Principal":
               "Service": "ec2.amazonaws.com"
      policies:
        - policy_name: "pwork_instance_policy"
          policy_document:
            "Version": "2012-10-17"
            "Statement":
              - "Effect": "Allow"
                "Action":
                  - "ec2:CreateImage"
                  - "ec2:DescribeImages"
                "Resource": "*"
  instanceprofiles:
    pwork_instance_prof:
      id: "pwork_instance_prof"
      roles:
        - "{{PWorkInstance.roles.pwork_instance_role.ref}}"
      instance_profile_name: "pwork_instance_prof"

  instances:
    pwork_instance:
      id: "pwork_instance"
      availability_zone: "ap-northeast-1a"
      block_device_mappings:
        - device_name: "/dev/xvda"
          ebs:
            delete_on_termination: true
            encrypted: false
            iops: 3000
            volume_size: 8
            volume_type: "gp3"
      iam_instance_profile: "{{PWorkInstance.instanceprofiles.pwork_instance_prof.ref}}"
      image_id: "ami-09cd9fdbf26acc6b4"
      instance_type: "t2.micro"
      key_name: "{{common.key_pair}}"
      network_interfaces:
        - device_index: "0"
          delete_on_termination: true
          associate_public_ip_address: true
          group_set:
            - "{{PWorkInstance.securitygrps.pwork_instance_sg.attr_group_id}}"
          subnet_id: "{{pwork.subnets.nyan_pub_subnet_az1.attr_subnet_id}}"
      tags:
        - key: "module"
          value: "PworkInstance"
        - key: "Name"
          value: "PworkInstance"